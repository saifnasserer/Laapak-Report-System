<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض التقرير | Laapak</title>
    
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/form-steps.css"> 
    <link rel="stylesheet" href="css/custom-admin.css">

    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Laapak Reports">
    <link rel="apple-touch-icon" href="img/icons/icon-152x152.png">
    
    <!-- Theme color for browser -->
    <meta name="theme-color" content="#0a3622">
    <style>
        :root {
            --primary-color: #007553;
            --primary-hover: #005a40;
            --secondary-color: #2a3f54;
            --accent-color: #0eaf54;
            --light-bg: #f8f9fa;
            --border-radius: 12px;
            --card-radius: 16px;
            --btn-radius: 10px;
            --input-radius: 10px;
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7f9;
            color: #333;
        }
        
        /* Card Styling */
        .card {
            border-radius: var(--card-radius) !important;
            overflow: hidden;
            transition: var(--transition);
            border: none !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05) !important;
        }
        
        .card-header {
            background: transparent !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important;
            padding: 1.25rem 1.5rem !important;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }
        
        /* Button Styling */
        .btn {
            border-radius: var(--btn-radius) !important;
            padding: 0.5rem 1.25rem !important;
            font-weight: 500 !important;
            transition: var(--transition);
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        
        /* Action Buttons Styling for Step 6 */
        .action-buttons .btn {
            text-align: right;
            padding: 1rem !important;
            transition: all 0.3s ease;
            border-radius: var(--btn-radius) !important;
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .action-buttons .icon-container {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.2);
            font-size: 1.2rem;
        }
        
        .action-buttons .btn-primary .icon-container {
            background-color: rgba(255,255,255,0.25);
        }
        
        .action-buttons .btn-success .icon-container {
            background-color: rgba(255,255,255,0.25);
        }
        
        .action-buttons .btn-info .icon-container {
            background-color: rgba(255,255,255,0.25);
        }
        
        .action-buttons .text-container {
            text-align: right;
        }
        
        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover) !important;
            border-color: var(--primary-hover) !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 117, 83, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #0eaf54 0%, #088f44 100%) !important;
            border: none !important;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(14, 175, 84, 0.2);
        }
        
        .report-header {
            background: linear-gradient(135deg, #0a592c 0%, #0d944d 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--card-radius);
            margin-bottom: 2rem;
            box-shadow: 0 8px 20px rgba(10, 89, 44, 0.2);
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* Section titles styling */
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .section-title .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            margin-right: 12px;
            box-shadow: 0 4px 10px rgba(0, 117, 83, 0.2);
        }
        
        .section-title .icon-wrapper i {
            font-size: 1.2rem;
        }
        
        /* Premium gallery styling */
        .gallery-item {
            overflow: hidden;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }
        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .gallery-item img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 0.75rem;
            transition: transform 0.5s ease;
        }
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        /* Flexible video container */
        .video-container {
    width: 100%;
    max-width: 100%;
    margin: 0 auto 2rem;
    border-radius: 0.5rem;
    overflow: hidden;
    position: relative;
    background-color: #000;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
}

/* Make iframe and video fill container without overflow */
.video-container iframe,
.video-container video {
    width: 100%;
    height: auto;
    display: block;
    border: none;
    background-color: #000;
}

/* Ensures native videos have a visible minimum height */
.video-container video {
    min-height: 500px;
    max-height: 80vh; /* Prevent video from being too tall on large screens */
    object-fit: cover; /* Ensures video fills space gracefully */
    border-radius: inherit;
}

/* Optional: Responsive aspect ratio if you ever want to re-enable it */
.video-container.aspect-ratio-16-9 {
    aspect-ratio: 16 / 9;
}

/* Mobile improvements */
@media (max-width: 600px) {
    .video-container {
        border-radius: 0;
        box-shadow: none;
        margin-bottom: 1.5rem;
    }

    .video-container video {
        min-height: 4200px;
    }
}

        /* Enhanced Video Player Styling */
        .video-container {
            position: relative;
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            overflow: hidden;
            background-color: #000;
            min-height: 360px;
        }
        
        .video-container video,
        .video-container iframe {
            width: 100%;
            display: block;
            background-color: #000;
            max-height: 70vh;
            min-height: 360px;
            border: none;
        }
        
        .video-controls {
            border-top: 1px solid rgba(0,0,0,0.1);
            padding: 0.75rem 1.25rem;
            background-color: #f8f9fa;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
        }
        
        .video-controls button {
            transition: all 0.2s ease;
            color: #495057;
        }
        
        .video-controls button:hover {
            background-color: #e9ecef;
            transform: scale(1.05);
        }
        
        /* Modern Gallery Styling */
        .gallery-grid .gallery-item {
            margin-bottom: 1.5rem;
        }
        
        .gallery-item .card {
            cursor: pointer;
            height: 100%;
        }
        
        .img-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: var(--card-radius) var(--card-radius) 0 0;
        }
        
        .img-wrapper img {
            object-fit: cover;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease;
        }
        
        .text-shadow {
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        /* Responsive gallery adjustments */
        @media (max-width: 768px) {
            .gallery-item {
                margin-bottom: 1rem;
            }
            
            .img-wrapper {
                aspect-ratio: 3/2;
            }
            
            .gallery-controls .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .section-icon-container {
                width: 32px !important;
                height: 32px !important;
            }
        }
        /* Premium test screenshot styling */
        .test-screenshot-card {
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border: none;
            margin-bottom: 2.5rem;
        }
        .test-screenshot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
        }
        .test-screenshot-card .card-img-top {
            width: 100%;
            object-fit: contain;
            background-color: #f8f9fa;
            padding: 0;
            transition: transform 0.5s ease;
            max-height: 500px;
            min-height: 320px;
        }
        .test-screenshot-card:hover .card-img-top {
            transform: scale(1.02);
        }
        .test-screenshot-card .card-body {
            padding: 2rem;
            background-color: #fff;
        }
        .test-screenshot-card .card-title {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
            color: #0a592c;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.75rem;
        }
        .test-screenshot-card .card-text {
            font-size: 1rem;
            color: #495057;
            line-height: 1.7;
        }
        .test-screenshot-explanation {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-top: 1rem;
            border-left: 4px solid #0a592c;
        }
        /* Notes section */
        .notes-section {
            white-space: pre-wrap; /* Preserve formatting */
            background-color: #f8f9fa;
            border-radius: 0.75rem;
            padding: 1.5rem !important;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            line-height: 1.8;
        }
        /* Zoom controls */
        .zoom-controls {
            background-color: rgba(0,0,0,0.5);
            border-radius: 1rem;
            padding: 0.5rem !important;
        }
        
        /* Responsive Progress Bar Styles */
        .steps-container {
            background: rgba(255,255,255,0.7);
            padding: 2rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 15px rgba(0,0,0,0.03);
            position: relative;
        }
        
        .steps-progress-line {
            top: calc(2rem + 25px);
            left: 0;
            right: 0;
            height: 3px;
            background-color: #e9ecef;
            z-index: 1;
        }
        
        .steps-progress-bar {
            top: calc(2rem + 25px);
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            z-index: 1;
            transition: width 0.3s ease;
        }
        
        /* Progress Bar Styling */
        .steps-container {
            background: rgba(255,255,255,0.7);
            padding: 2rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 3px 15px rgba(0,0,0,0.03);
            position: relative;
        }
        
        .steps-progress-line {
            position: absolute;
            top: calc(2rem + 25px);
            left: 0;
            right: 0;
            height: 3px;
            background-color: #e9ecef;
            z-index: 1;
        }
        
        .steps-progress-bar {
            position: absolute;
            top: calc(2rem + 25px);
            left: 0;
            height: 3px;
            width: 0%; /* Initial width, will be updated by JS */
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            z-index: 1;
            transition: width 0.3s ease;
        }
        
        .step-item {
            position: relative;
            z-index: 2;
        }
        
        .step-button {
            width: 50px !important;
            height: 50px !important;
            font-weight: 600 !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            border: none !important;
            padding: 0 !important;
        }
        
        .step-item.active .step-button {
            background-color: var(--primary-color) !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(0, 117, 83, 0.25) !important;
        }
        
        .step-item:not(.active) .step-button {
            background-color: white !important;
            color: var(--primary-color) !important;
            border: 2px solid var(--primary-color) !important;
        }
        
        /* Mobile Progress Bar Styles */
        @media (max-width: 991px) {
            .steps-wrapper {
                padding: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                -ms-overflow-style: none; /* IE and Edge */
                scrollbar-width: none; /* Firefox */
            }
            
            .steps-wrapper::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
            
            .steps-slider {
                display: flex;
                min-width: max-content;
                padding: 1rem 0.5rem;
            }
            
            .step-item {
                flex: 0 0 auto;
                margin: 0 1rem;
                min-width: 80px;
            }
            
            .step-item .step-title {
                width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .steps-progress-line, .steps-progress-bar {
                top: calc(1rem + 25px);
            }
            
            .steps-navigation {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 1rem;
            }
            
            .step-nav-btn {
                background: transparent;
                border: none;
                color: var(--primary-color);
                font-size: 1.25rem;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .step-nav-btn:hover {
                background-color: rgba(0, 117, 83, 0.1);
            }
            
            .step-indicator {
                font-size: 0.875rem;
                color: #495057;
                margin: 0 0.75rem;
                min-width: 80px;
                text-align: center;
            }
            
            .steps-container {
                padding: 1rem 0.5rem 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Container - (Optional: Can be populated by a shared header component if you have one) -->
    <!-- <div id="header-container"></div> -->

    <div class="container-fluid p-4 mt-2">
        <div class="report-header text-center">
            <h1 id="reportTitle">تقرير فحص جهاز</h1>
            <p class="lead mb-0">رقم الطلب: <span id="reportOrderNumberHeader">-</span></p>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <!-- Form Step Indicator -->
                <div class="row mb-5">
                    <div class="col-12">
                        <!-- Responsive Steps Container -->
                        <div class="steps-container position-relative">
                            <!-- Desktop & Mobile Step Items -->
                            <div class="steps-wrapper">
                                <div class="steps-slider justify-content-between align-items-center position-relative" style="z-index: 2; display: flex">
                                    <!-- Step 1 -->
                                    <div class="step-item text-center active" data-step="1">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; box-shadow: 0 4px 15px rgba(0, 117, 83, 0.25); border: none; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">1</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">تفاصيل الطلب</div>
                                    </div>
                                    
                                    <!-- Step 2 -->
                                    <div class="step-item text-center" data-step="2">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-outline-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; border-width: 2px; background-color: white; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">2</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">المعاينة الخارجية</div>
                                    </div>
                                    
                                    <!-- Step 3 -->
                                    <div class="step-item text-center" data-step="3">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-outline-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; border-width: 2px; background-color: white; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">3</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">الفحص الداخلي</div>
                                    </div>
                                    
                                    <!-- Step 4 -->
                                    <div class="step-item text-center" data-step="4">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-outline-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; border-width: 2px; background-color: white; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">4</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">المكونات الاساسية</div>
                                    </div>
                                    
                                    <!-- Step 5 -->
                                    <div class="step-item text-center" data-step="5">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-outline-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; border-width: 2px; background-color: white; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">5</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">ملاحظات</div>
                                    </div>
                                    
                                    <!-- Step 6 -->
                                    <div class="step-item text-center" data-step="6">
                                        <div class="step-circle-container position-relative d-inline-flex justify-content-center">
                                            <button type="button" class="step-button btn btn-outline-primary position-relative" style="width: 50px; height: 50px; font-weight: 600; border-width: 2px; background-color: white; z-index: 2; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">6</button>
                                        </div>
                                        <div class="step-title mt-2" style="font-weight: 500; font-size: 0.9rem;">تأكيد الطلب</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile Navigation Controls (Visible only on small screens) -->
                            <div class="steps-navigation d-none d-md-none">
                                <button type="button" class="step-nav-btn prev-step" aria-label="Previous Step">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <div class="step-indicator">
                                    <span class="current-step-number">1</span> / <span class="total-steps">6</span>
                                </div>
                                <button type="button" class="step-nav-btn next-step" aria-label="Next Step">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </div>
                            
                            <!-- Connecting Line (positioned in the middle of the circles) -->
                            <div class="position-absolute steps-progress-line"></div>
                            
                            <!-- Progress bar (overlays the connecting line) -->
                            <div class="position-absolute steps-progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: General Information -->
                <div class="form-step step-content active" id="step1">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3 justify-content-center">
                            <p><strong>اسم العميل:</strong> <span id="clientName">-</span></p>
                            <p><strong>رقم الهاتف:</strong> <span id="clientPhone">-</span></p>
                            <p><strong>البريد الإلكتروني:</strong> <span id="clientEmail">-</span></p>
                            <p><strong>عنوان العميل:</strong> <span id="clientAddress">-</span></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <p><strong>رقم الطلب:</strong> <span id="orderNumber">-</span></p>
                            <p><strong>طراز الجهاز:</strong> <span id="deviceModel">-</span></p>
                            <p><strong>الرقم التسلسلي:</strong> <span id="serialNumber">-</span></p>
                            <p><strong>تاريخ الفحص:</strong> <span id="inspectionDate">-</span></p>
                            <p><strong>حالة التقرير:</strong> <span id="reportStatus" class="badge">-</span></p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: External Inspection -->
                <div class="form-step step-content" id="step2">
                    
                    
                    <!-- Modern Video Section with Enhanced Player -->
                    <div class="device-video-section mb-5 text-center">
                        <div class="d-flex align-items-center mb-3 justify-content-center">
                            <!-- <div class="section-icon-container me-2" style="width: 38px; height: 38px; background: linear-gradient(135deg, #0a592c 0%, #0d944d 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-film" style="color: white; font-size: 1rem;"></i>
                            </div> -->
                            <h5 class="mb-0 fw-bold">فيديو الجهاز</h5>
                        </div>
                        <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: var(--card-radius);">
                            <div class="card-body p-0">
                                <div id="deviceVideoContainer" class="video-container position-relative" style="background-color: #000; display: flex; align-items: center; justify-content: center;">
                                    <!-- Video will be injected here by JavaScript -->
                                    <div class="video-placeholder d-flex flex-column align-items-center justify-content-center text-center" style="color: #ccc; padding: 2rem;">
                                        <i class="fas fa-film mb-3" style="font-size: 3rem; opacity: 0.5;"></i>
                                        <p class="mb-0">جاري تحميل الفيديو...</p>
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modern Gallery Section with Enhanced UI -->
                    <div class="device-gallery-section mb-5 text-center">
                        <div class="d-flex align-items-center mb-3 justify-content-center">
                            <!-- <div class="section-icon-container me-2" style="width: 38px; height: 38px; background: linear-gradient(135deg, #0a592c 0%, #0d944d 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-images" style="color: white; font-size: 1rem;"></i>
                            </div> -->
                            <h5 class="mb-0 fw-bold">الصور خارجية</h5>
                        </div>
                        <div class="card border-0 shadow-sm" style="border-radius: var(--card-radius); overflow: hidden;">
                            <div class="card-header bg-white d-flex align-items-center justify-content-between" style="border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1rem 1.5rem;">
                                <span class="text-muted small"><i class="fas fa-info-circle me-1"></i> اضغط على أي صورة لعرضها بالحجم الكامل</span>
                                
                            </div>
                            <div class="card-body p-3">
                                <div id="externalImagesGallery" class="row g-3 gallery-grid">
                                    <!-- Images will be injected here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Premium lightbox modal with navigation -->
                    <div class="modal fade" id="imageLightbox" tabindex="-1" aria-labelledby="imageLightboxLabel" aria-hidden="true">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content bg-dark">
                                <div class="modal-header border-bottom-0 text-white">
                                    <h5 class="modal-title" id="imageLightboxLabel">عرض الصورة</h5>
                                    <div class="lightbox-counter text-white ms-3">
                                        <span id="currentImageIndex">1</span>/<span id="totalImages">1</span>
                                    </div>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center p-0 d-flex align-items-center justify-content-center position-relative">
                                    <!-- Navigation arrows -->
                                    <button id="prevImage" class="btn btn-dark position-absolute start-0 top-50 translate-middle-y opacity-75 d-none d-md-block" style="z-index: 10">
                                        <i class="fas fa-chevron-left fa-2x"></i>
                                    </button>
                                    <button id="nextImage" class="btn btn-dark position-absolute end-0 top-50 translate-middle-y opacity-75 d-none d-md-block" style="z-index: 10">
                                        <i class="fas fa-chevron-right fa-2x"></i>
                                    </button>
                                    
                                    <!-- Image container with zoom -->
                                    <div class="position-relative overflow-hidden w-100 h-100 d-flex align-items-center justify-content-center" style="height: 90vh;">
                                        <img src="" id="lightboxImage" class="img-fluid" 
                                             alt="Expanded Image" style="max-height: 90vh; max-width: 100%; object-fit: contain; transition: transform 0.3s ease;">
                                    </div>
                                    
                                    <!-- Controls overlay -->
                                    <div class="lightbox-controls position-absolute bottom-0 start-0 end-0 d-flex justify-content-between align-items-center p-3 bg-gradient-dark" style="background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0))">
                                        <div>
                                            <button id="fullscreenToggle" class="btn btn-sm btn-outline-light me-2">
                                                <i class="fas fa-expand"></i>
                                            </button>
                                        </div>
                                        <div class="zoom-controls">
                                            <button id="zoomOut" class="btn btn-sm btn-outline-light me-2">
                                                <i class="fas fa-search-minus"></i>
                                            </button>
                                            <button id="zoomReset" class="btn btn-sm btn-outline-light me-2">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button id="zoomIn" class="btn btn-sm btn-outline-light">
                                                <i class="fas fa-search-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Enhanced Test Screenshots -->
                <div class="form-step step-content" id="step4">
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <div class="me-3"><i class="fas fa-info-circle fa-2x"></i></div>
                            <div>
                                <h5 class="alert-heading">عن هذا القسم</h5>
                                <p>توضح لقطات الشاشة هذه نتائج الاختبارات التفصيلية التي تم إجراؤها على الجهاز. تساعد هذه الصور على تقييم حالة المكونات الداخلية وأدائها بدقة.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Full-width test screenshots -->
                    <div id="newTestScreenshotsContainer" class="test-screenshots-container"></div>
                </div>

                <!-- Step 3: Technical Hardware Tests -->
                <div class="form-step step-content" id="step3">
                    <h4 class="mb-4 section-title">
                        <span class="icon-wrapper">
                            <i class="fas fa-microchip"></i>
                        </span>
                        <span>الفحوصات التقنية للمكونات</span>
                    </h4>
                    <div id="hardwareStatusTableContainer">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>المكون</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="hardwareStatusTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                        <div class="alert alert-success mt-3 text-center">
                            <i class="fas fa-check-circle me-2"></i>
                            تم اختبار وتشغيل جميع المكونات المذكورة والتأكد انها تعمل بشكل كامل
                        </div>
                    </div>
                </div>

                <!-- Step 5: Technician Notes (renamed from Step 4) -->
                <div class="form-step step-content" id="step5">
                    <h4 class="mb-4 border-bottom pb-2"><i class="fas fa-sticky-note me-2"></i>ملاحظات الفني</h4>
                    <div class="card shadow-sm border-0 p-4 mb-4">
                        <div id="technicianNotes" class="p-3 bg-light rounded notes-section fs-5">لا توجد ملاحظات</div>
                    </div>
                </div>

                <!-- Step 6: Next Steps & Client Actions (placeholder) -->
                <div class="form-step step-content" id="step6">
                    
                    
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <div class="action-buttons d-grid gap-3 col-lg-8 mx-auto">
                                <a href="client-dashboard.html#invoices-tab" class="btn btn-primary d-flex align-items-center justify-content-center py-3" id="viewInvoiceBtn" style="background: linear-gradient(135deg, #007bff, #0056b3); border: none; box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(0, 123, 255, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(0, 123, 255, 0.2)';">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-container me-3 d-flex align-items-center justify-content-center" style="width: 46px; height: 46px; background: rgba(255,255,255,0.25); border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                            <i class="fas fa-file-invoice" style="font-size: 1.25rem;"></i>
                                        </div>
                                        <div class="text-container">
                                            <span class="fw-medium">عرض الفاتورة</span>
                                            <small class="d-block opacity-75 mt-1">شوف تفاصيل الفاتورة</small>
                                        </div>
                                    </div>
                                </a>
                                
                                <a href="https://wa.me/+201234567890?text=%D9%85%D8%B1%D8%AD%D8%A8%D8%A7%D9%8B%D8%8C%20%D8%A3%D9%88%D8%AF%20%D8%A7%D9%84%D8%AA%D8%A3%D9%83%D9%8A%D8%AF%20%D8%B9%D9%84%D9%89%20%D8%A7%D9%84%D8%A3%D9%88%D8%B1%D8%AF%D8%B1%20%D8%A7%D9%84%D8%AE%D8%A7%D8%B5%20%D8%A8%D9%8A%20%D9%84%D9%8A%D8%AA%D9%85%20%D8%B4%D8%AD%D9%86%20%D8%A7%D9%84%D9%84%D8%A7%D8%A8%D8%AA%D9%88%D8%A8" class="btn btn-success d-flex align-items-center justify-content-center py-3" id="whatsAppChatBtn" target="_blank" style="background: linear-gradient(135deg, #25d366, #128C7E); border: none; box-shadow: 0 5px 15px rgba(37, 211, 102, 0.2); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(37, 211, 102, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 15px rgba(37, 211, 102, 0.2)';">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-container me-3 d-flex align-items-center justify-content-center" style="width: 46px; height: 46px; background: rgba(255,255,255,0.25); border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                            <i class="fab fa-whatsapp" style="font-size: 1.5rem;"></i>
                                        </div>
                                        <div class="text-container">
                                            <span class="fw-medium">تواصل معنا عبر واتساب</span>
                                            <small class="d-block opacity-75 mt-1">كلمنا دلوقتي وأكد الاوردر عشان يتم شحن اللابتوب</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-5 form-navigation">
                    <button type="button" class="btn btn-outline-secondary px-4 py-2" id="prevBtn" disabled>
                        <i class="fas fa-arrow-right me-2"></i>
                        <span>السابق</span>
                    </button>
                    
                    <button type="button" class="btn btn-primary px-4 py-2" id="nextBtn">
                        <span>التالي</span>
                        <i class="fas fa-arrow-left ms-2"></i>
                    </button>
                </div>
            </div> <!-- Closing card-body -->
        </div> <!-- Closing card -->
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Image Lightbox -->
    <div id="simpleLightbox" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-none" style="z-index: 1050;">
        <div class="position-absolute top-0 end-0 p-3">
            <button type="button" class="btn btn-light rounded-circle" id="closeLightbox">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="position-absolute top-50 start-0 p-3">
            <button type="button" class="btn btn-light rounded-circle" id="prevImageSimple">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="position-absolute top-50 end-0 p-3">
            <button type="button" class="btn btn-light rounded-circle" id="nextImageSimple">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="position-absolute bottom-0 start-0 w-100 p-3 text-white text-center">
            <span id="currentIndexSimple">1</span> / <span id="totalImagesSimple">1</span>
        </div>
        
        <div class="d-flex justify-content-center align-items-center h-100">
            <img id="lightboxImageSimple" src="" alt="صورة الجهاز" class="img-fluid" style="max-height: 90vh; max-width: 90vw; object-fit: contain;">
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS for report view -->
    <script src="js/report-view.js"></script>
    
    <!-- Progress Bar and Step Navigation Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Progress bar elements
            const stepsWrapper = document.querySelector('.steps-wrapper');
            const stepsSlider = document.querySelector('.steps-slider');
            const stepItems = document.querySelectorAll('.step-item');
            const progressBar = document.querySelector('.steps-progress-bar');
            const progressLine = document.querySelector('.steps-progress-line');
            const totalStepsEl = document.querySelector('.total-steps');
            const currentStepNumberEl = document.querySelector('.current-step-number');
            const prevStepBtn = document.querySelector('.prev-step');
            const nextStepBtn = document.querySelector('.next-step');
            const mainPrevBtn = document.getElementById('prevBtn');
            const mainNextBtn = document.getElementById('nextBtn');
            let currentStepIndex = 0; // 0-based index for the current step
            const totalSteps = stepItems.length;
            
            // Initialize the steps navigation
            function initStepsNavigation() {
                // Set total steps
                if (totalStepsEl) {
                    totalStepsEl.textContent = totalSteps;
                }
                
                // Update current step number
                if (currentStepNumberEl) {
                    currentStepNumberEl.textContent = currentStepIndex + 1;
                }
                
                // Add the progress line if it doesn't exist
                if (!progressLine) {
                    const newProgressLine = document.createElement('div');
                    newProgressLine.className = 'position-absolute steps-progress-line';
                    document.querySelector('.steps-container').appendChild(newProgressLine);
                }
                
                // Show/hide mobile navigation on small screens
                const stepsNavigation = document.querySelector('.steps-navigation');
                if (stepsNavigation && window.innerWidth <= 991) {
                    stepsNavigation.classList.remove('d-none');
                    stepsNavigation.classList.add('d-flex');
                }
                
                // Handle step navigation buttons
                if (prevStepBtn) {
                    prevStepBtn.addEventListener('click', function() {
                        if (currentStepIndex > 0) {
                            navigateToStep(currentStepIndex - 1);
                        }
                    });
                }
                
                if (nextStepBtn) {
                    nextStepBtn.addEventListener('click', function() {
                        if (currentStepIndex < totalSteps - 1) {
                            navigateToStep(currentStepIndex + 1);
                        }
                    });
                }
                
                // Handle main navigation buttons
                if (mainPrevBtn) {
                    mainPrevBtn.addEventListener('click', function() {
                        if (currentStepIndex > 0) {
                            navigateToStep(currentStepIndex - 1);
                        }
                    });
                }
                
                if (mainNextBtn) {
                    mainNextBtn.addEventListener('click', function() {
                        if (currentStepIndex < totalSteps - 1) {
                            navigateToStep(currentStepIndex + 1);
                        }
                    });
                }
                
                // Make step buttons clickable
                stepItems.forEach((item, index) => {
                    const stepButton = item.querySelector('.step-button');
                    if (stepButton) {
                        stepButton.addEventListener('click', function() {
                            navigateToStep(index);
                        });
                    }
                });
                
                // Find active step (if any)
                stepItems.forEach((item, index) => {
                    if (item.classList.contains('active')) {
                        currentStepIndex = index;
                        updateProgressBar();
                    }
                });
                
                // Enable touch swiping on mobile
                if (window.innerWidth <= 991 && stepsWrapper) {
                    let touchStartX = 0;
                    let touchEndX = 0;
                    
                    stepsWrapper.addEventListener('touchstart', function(e) {
                        touchStartX = e.changedTouches[0].screenX;
                    }, { passive: true });
                    
                    stepsWrapper.addEventListener('touchend', function(e) {
                        touchEndX = e.changedTouches[0].screenX;
                        handleSwipe();
                    }, { passive: true });
                    
                    function handleSwipe() {
                        const swipeThreshold = 50;
                        if (touchEndX < touchStartX - swipeThreshold) {
                            // Swiped left - next step (for RTL direction)
                            if (currentStepIndex < totalSteps - 1) {
                                navigateToStep(currentStepIndex + 1);
                            }
                        }
                        if (touchEndX > touchStartX + swipeThreshold) {
                            // Swiped right - previous step (for RTL direction)
                            if (currentStepIndex > 0) {
                                navigateToStep(currentStepIndex - 1);
                            }
                        }
                    }
                }
            }
            
            // Navigate to a specific step
            function navigateToStep(stepIndex) {
                // Update active state
                stepItems.forEach((item, idx) => {
                    if (idx === stepIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // Update current step index
                currentStepIndex = stepIndex;
                
                // Update progress bar
                updateProgressBar();
                
                // Update step number indicator
                if (currentStepNumberEl) {
                    currentStepNumberEl.textContent = currentStepIndex + 1;
                }
                
                // Scroll to the active step in mobile view
                if (window.innerWidth <= 991 && stepItems[stepIndex]) {
                    const stepItem = stepItems[stepIndex];
                    scrollToStep(stepItem);
                }
                
                // Show/hide navigation buttons based on position
                updateNavigationButtons();
                
                // Show the corresponding content section
                const stepContents = document.querySelectorAll('.form-step');
                stepContents.forEach((content, idx) => {
                    if (idx === stepIndex) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
            }
            
            // Scroll to the selected step (mobile view)
            function scrollToStep(stepItem) {
                if (!stepsSlider || !stepItem) return;
                
                const containerWidth = stepsWrapper.offsetWidth;
                const itemLeft = stepItem.offsetLeft;
                const itemWidth = stepItem.offsetWidth;
                
                // Calculate the scroll position to center the item
                const scrollLeft = itemLeft - (containerWidth / 2) + (itemWidth / 2);
                
                // Smooth scroll to the position
                stepsWrapper.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });
            }
            
            // Update progress bar width
            function updateProgressBar() {
                if (!progressBar || totalSteps <= 1) return;
                
                const progressPercentage = (currentStepIndex / (totalSteps - 1)) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                
                // Highlight completed steps
                stepItems.forEach((item, idx) => {
                    const stepButton = item.querySelector('.step-button');
                    if (idx < currentStepIndex) {
                        // Completed step
                        item.classList.add('completed');
                        stepButton.classList.remove('btn-outline-primary');
                        stepButton.classList.add('btn-primary');
                    } else if (idx === currentStepIndex) {
                        // Current step
                        item.classList.remove('completed');
                        stepButton.classList.remove('btn-outline-primary');
                        stepButton.classList.add('btn-primary');
                    } else {
                        // Future step
                        item.classList.remove('completed');
                        stepButton.classList.remove('btn-primary');
                        stepButton.classList.add('btn-outline-primary');
                    }
                });
            }
            
            // Update navigation buttons state
            function updateNavigationButtons() {
                // Update mobile navigation buttons
                if (prevStepBtn) {
                    prevStepBtn.disabled = currentStepIndex === 0;
                    prevStepBtn.style.opacity = currentStepIndex === 0 ? '0.5' : '1';
                }
                
                if (nextStepBtn) {
                    nextStepBtn.disabled = currentStepIndex === totalSteps - 1;
                    nextStepBtn.style.opacity = currentStepIndex === totalSteps - 1 ? '0.5' : '1';
                }
                
                // Update main navigation buttons
                if (mainPrevBtn) {
                    mainPrevBtn.disabled = currentStepIndex === 0;
                    mainPrevBtn.style.opacity = currentStepIndex === 0 ? '0.5' : '1';
                }
                
                if (mainNextBtn) {
                    if (currentStepIndex === totalSteps - 1) {
                        mainNextBtn.style.display = 'none';
                    } else {
                        mainNextBtn.style.display = 'flex';
                    }
                }
            }
            
            // Initialize steps navigation
            initStepsNavigation();
            
            // Update progress bar for initial state
            updateProgressBar();
            updateNavigationButtons();
            
            // Re-initialize on window resize
            window.addEventListener('resize', function() {
                const stepsNavigation = document.querySelector('.steps-navigation');
                if (stepsNavigation) {
                    if (window.innerWidth <= 991) {
                        stepsNavigation.classList.remove('d-none');
                        stepsNavigation.classList.add('d-flex');
                    } else {
                        stepsNavigation.classList.add('d-none');
                        stepsNavigation.classList.remove('d-flex');
                    }
                }
            });
            
            // Action buttons in Step 6
            const viewInvoiceBtn = document.getElementById('viewInvoiceBtn');
            const whatsAppChatBtn = document.getElementById('whatsAppChatBtn');
            const contactUsBtn = document.getElementById('contactUsBtn');
            const shareReportBtn = document.getElementById('shareReportBtn');
            
            // Company phone number for WhatsApp (can be set dynamically)
            const companyWhatsAppNumber = '+201234567890'; // Replace with actual number
            
            // Get report data from URL parameters or global variable
            const reportId = new URLSearchParams(window.location.search).get('id') || 'LPK123456';
            
            // Share Report Button
            if (shareReportBtn) {
                shareReportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Check if Web Share API is available
                    if (navigator.share) {
                        navigator.share({
                            title: `تقرير فحص جهاز - ${reportId}`,
                            text: 'ريبورت جهازك الجديد دلوقتي جاهز !',
                            url: window.location.href
                        })
                        .catch(error => console.error('Error sharing:', error));
                    } else {
                        // Fallback for browsers that don't support the Web Share API
                        const reportUrl = window.location.href;
                        prompt('انسخ هذا الرابط لمشاركة التقرير:', reportUrl);
                    }
                });
            }
        });
    </script>
    
    <!-- Enhanced lightbox functionality with zoom, navigation, and fullscreen -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initial variables
            let currentZoomLevel = 1;
            const zoomStep = 0.25;
            const maxZoom = 3;
            const minZoom = 0.5;
            let isDragging = false;
            let startX, startY, initialTranslateX = 0, initialTranslateY = 0;
            let currentTranslateX = 0, currentTranslateY = 0;
            
            // Get lightbox elements
            const lightboxModal = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const zoomResetBtn = document.getElementById('zoomReset');
            const fullscreenToggle = document.getElementById('fullscreenToggle');
            const prevImageBtn = document.getElementById('prevImage');
            const nextImageBtn = document.getElementById('nextImage');
            
            if (!lightboxImage || !lightboxModal) return;
            
            // Zoom in function
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', function() {
                    if (currentZoomLevel < maxZoom) {
                        currentZoomLevel += zoomStep;
                        updateZoom();
                    }
                });
            }
            
            // Zoom out function
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', function() {
                    if (currentZoomLevel > minZoom) {
                        currentZoomLevel -= zoomStep;
                        updateZoom();
                    }
                });
            }
            
            // Reset zoom function
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('click', function() {
                    currentZoomLevel = 1;
                    currentTranslateX = 0;
                    currentTranslateY = 0;
                    updateZoom();
                });
            }
            
            // Fullscreen toggle
            if (fullscreenToggle) {
                fullscreenToggle.addEventListener('click', function() {
                    if (!document.fullscreenElement) {
                        lightboxModal.requestFullscreen().catch(err => {
                            console.error(`Error attempting to enable fullscreen: ${err.message}`);
                        });
                        fullscreenToggle.innerHTML = '<i class="fas fa-compress"></i>';
                    } else {
                        document.exitFullscreen();
                        fullscreenToggle.innerHTML = '<i class="fas fa-expand"></i>';
                    }
                });
            }
            
            // Handle zooming with mouse wheel
            lightboxImage.addEventListener('wheel', function(e) {
                e.preventDefault();
                if (e.deltaY < 0 && currentZoomLevel < maxZoom) {
                    // Zoom in
                    currentZoomLevel += zoomStep;
                } else if (e.deltaY > 0 && currentZoomLevel > minZoom) {
                    // Zoom out
                    currentZoomLevel -= zoomStep;
                }
                updateZoom();
            });
            
            // Image dragging when zoomed
            lightboxImage.addEventListener('mousedown', function(e) {
                if (currentZoomLevel > 1) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTranslateX = currentTranslateX;
                    initialTranslateY = currentTranslateY;
                    lightboxImage.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging && currentZoomLevel > 1) {
                    const diffX = e.clientX - startX;
                    const diffY = e.clientY - startY;
                    currentTranslateX = initialTranslateX + diffX / currentZoomLevel;
                    currentTranslateY = initialTranslateY + diffY / currentZoomLevel;
                    updateZoom();
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    lightboxImage.style.cursor = 'grab';
                }
            });
            
            // Double-click to reset zoom
            lightboxImage.addEventListener('dblclick', function() {
                if (currentZoomLevel !== 1) {
                    currentZoomLevel = 1;
                    currentTranslateX = 0;
                    currentTranslateY = 0;
                } else {
                    currentZoomLevel = 2; // Zoom to 2x on double-click if already at 1x
                }
                updateZoom();
            });
            
            // Reset zoom and position when modal is closed
            lightboxModal.addEventListener('hidden.bs.modal', function() {
                currentZoomLevel = 1;
                currentTranslateX = 0;
                currentTranslateY = 0;
                updateZoom();
            });
            
            // Update image transform based on zoom level and position
            function updateZoom() {
                if (currentZoomLevel === 1) {
                    // Reset position at 1x zoom
                    currentTranslateX = 0;
                    currentTranslateY = 0;
                    lightboxImage.style.cursor = 'default';
                } else {
                    lightboxImage.style.cursor = 'grab';
                }
                
                lightboxImage.style.transform = `scale(${currentZoomLevel}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
            }
        });
    </script>
</body>
</html>
