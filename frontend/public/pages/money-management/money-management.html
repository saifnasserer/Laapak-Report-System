<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الأموال والتحويلات - نظام تقارير لاباك</title>

    <!-- Favicon -->
    <link rel="icon" href="../../assets/images/cropped-Logo-mark.png.png" type="image/png">

    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="../../styles/base/styles.css">
    <link rel="stylesheet" href="../../styles/pages/financial-design.css">
</head>

<body class="finance-layout">
    <div class="container-fluid py-4" style="max-width: 1400px; margin: 0 auto;">
        <!-- Header Component -->
        <div class="finance-header-container mb-4"></div>

        <!-- Page Header -->
        <div class="finance-card mb-4 overflow-hidden position-relative">
            <div class="p-4 position-relative z-1">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="icon-circle bg-success-subtle text-success">
                                <i class="fas fa-wallet fa-2x"></i>
                            </div>
                            <div>
                                <h1 class="fw-bold mb-0 h2">إدارة الأموال</h1>
                                <p class="text-muted mb-0">تتبع الخزائن، المحافظ الرقمية، والحسابات البنكية</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5 text-md-end mt-3 mt-md-0">
                        <div class="d-flex gap-2 justify-content-md-end flex-wrap">
                            <button class="btn btn-primary" onclick="showTransferModal()">
                                <i class="fas fa-exchange-alt me-2"></i>تحويل
                            </button>
                            <button class="btn btn-success" onclick="showDepositModal()">
                                <i class="fas fa-plus me-2"></i>إيداع
                            </button>
                            <button class="btn btn-danger" onclick="showWithdrawalModal()">
                                <i class="fas fa-minus me-2"></i>سحب
                            </button>
                            <button class="btn btn-light" onclick="MoneyActions.refreshData()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10 bg-gradient-success"></div>
        </div>

        <!-- KPI Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="finance-card kpi-card h-100 p-4 bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="kpi-icon bg-white text-primary bg-opacity-25">
                            <i class="fas fa-coins"></i>
                        </div>
                        <span class="badge bg-white text-primary">الإجمالي</span>
                    </div>
                    <h3 class="fw-bold mb-1 text-white" id="totalBalance">0 ج.م</h3>
                    <p class="text-white text-opacity-75 small mb-0">إجمالي الرصيد</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="finance-card kpi-card h-100 p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="kpi-icon bg-info-subtle text-info">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1" id="totalLocations">0</h3>
                    <p class="text-muted small mb-0">مواقع الأموال</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="finance-card kpi-card h-100 p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="kpi-icon bg-warning-subtle text-warning">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1" id="totalMovements">0</h3>
                    <p class="text-muted small mb-0">إجمالي الحركات</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="finance-card kpi-card h-100 p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="kpi-icon bg-danger-subtle text-danger">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <span class="badge bg-danger-subtle text-danger">اليوم</span>
                    </div>
                    <h3 class="fw-bold mb-1" id="todayMovements">0</h3>
                    <p class="text-muted small mb-0">حركات اليوم</p>
                </div>
            </div>
        </div>

        <!-- Payment Methods & Analytics -->
        <div class="mb-4">
            <h5 class="fw-bold mb-3"><i class="fas fa-credit-card text-primary me-2"></i>طرق الدفع والأرصدة</h5>
            <div id="unifiedPaymentMethodsContainer">

            </div>
        </div>

        <!-- Detailed View: Locations & Movements -->
        <div class="row g-4">
            <!-- Locations List (Hidden default, populated by existing JS logic if needed, but Unified View is better) -->
            <!-- The existing JS populates 'locationsContainer' but we might not need to show it explicitly if Unified Methods covers it. 
                 However, specific locations (e.g. multiple wallets) might be useful. 
                 I'll add it in a collapsed/secondary section or side-by-side with movements. -->

            <div class="col-lg-4">
                <div class="finance-card h-100">
                    <div class="card-header bg-transparent border-bottom p-3">
                        <h5 class="fw-bold mb-0">تفاصيل المواقع</h5>
                    </div>
                    <div class="card-body p-3">
                        <div id="locationsContainer">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="finance-card h-100">
                    <div
                        class="card-header bg-transparent border-bottom p-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">آخر الحركات</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="MoneyActions.refreshMovements()">
                            <i class="fas fa-refresh me-1"></i> تحديث
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <div id="movementsContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">جاري تحميل الحركات...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Canvas Elements for JS compatibility -->
        <div class="d-none">
            <canvas id="balanceChart"></canvas>
            <canvas id="movementsChart"></canvas>
        </div>

    </div>

    <!-- Modals -->
    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-exchange-alt text-primary me-2"></i>تحويل أموال
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="transferForm">
                        <div class="mb-3">
                            <label class="form-label">من موقع</label>
                            <select class="form-select" id="fromLocation" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">إلى موقع</label>
                            <select class="form-select" id="toLocation" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="transferAmount" step="0.01" min="0.01"
                                    required>
                                <span class="input-group-text">ج.م</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="transferDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary px-4" onclick="executeTransfer()">تنفيذ
                        التحويل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-plus-circle text-success me-2"></i>إيداع أموال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="depositForm">
                        <div class="mb-3">
                            <label class="form-label">إلى موقع</label>
                            <select class="form-select" id="depositLocation" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="depositAmount" step="0.01" min="0.01"
                                    required>
                                <span class="input-group-text">ج.م</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="depositDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success px-4" onclick="executeDeposit()">تنفيذ الإيداع</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal fade" id="withdrawalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-minus-circle text-danger me-2"></i>سحب أموال</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="withdrawalForm">
                        <div class="mb-3">
                            <label class="form-label">من موقع</label>
                            <select class="form-select" id="withdrawalLocation" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="withdrawalAmount" step="0.01" min="0.01"
                                    required>
                                <span class="input-group-text">ج.م</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الوصف</label>
                            <textarea class="form-control" id="withdrawalDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger px-4" onclick="executeWithdrawal()">تنفيذ السحب</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../scripts/core/config.js"></script>
    <script src="../../scripts/core/auth-check.js"></script>
    <!-- Use the middleware if it exists, otherwise check will trigger -->
    <script src="../../scripts/core/auth-middleware.js"></script>

    <!-- <script src="../../scripts/components/finance-header-component.js"></script> -->
    <script>
        // Load Header
        fetch('../../components/finance-header.html')
            .then(response => response.text())
            .then(data => {
                document.querySelector('.finance-header-container').innerHTML = data;
                // Highlight active link
                setTimeout(() => {
                    const currentPath = window.location.pathname;
                    document.querySelectorAll('.nav-link').forEach(link => {
                        if (link.getAttribute('href') && currentPath.includes(link.getAttribute('href'))) {
                            link.classList.add('active');
                        }
                    });
                }, 100);
            });
    </script>
    <script src="../../scripts/pages/financial/financial-utils.js"></script>
    <script src="../../scripts/pages/financial/money-management.js"></script>
</body>

</html>